# VPSç”¨å®Ÿè¡Œã‚³ãƒãƒ³ãƒ‰é›†ï¼ˆv4.1.0 ã‚¢ã‚¤ã‚­ãƒ£ãƒƒãƒç”»åƒå¯¾å¿œç‰ˆï¼‰

## ã€é‡è¦ã€‘æœ€æ–°ç‰ˆã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆæ‰‹é †
echo "ğŸš€ ã‚¢ã‚¤ã‚­ãƒ£ãƒƒãƒç”»åƒå¯¾å¿œç‰ˆã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆé–‹å§‹..."

# æœ€æ–°ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—
git pull origin main

## ã€æ–°æ©Ÿèƒ½ã€‘æŠ•ç¨¿ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ãƒªã‚»ãƒƒãƒˆ
echo "æŠ•ç¨¿æ—¥æ™‚ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦ç¿Œæ—¥0:00ã‹ã‚‰é–‹å§‹..."
cd /home/member1/wordpress-auto-posting
export PYTHONPATH=/home/member1/wordpress-auto-posting
python3 -m src.main --reset-posted-count

# å¤ã„cronè¨­å®šã‚’å®Œå…¨å‰Šé™¤
echo "å¤ã„cronè¨­å®šå‰Šé™¤ä¸­..."
crontab -r

# æ–°ã—ã„cronè¨­å®šã‚’ä½œæˆ
echo "æ–°ã—ã„cronè¨­å®šä½œæˆä¸­..."
cat > /tmp/new_cron << 'EOF'
# WordPressè‡ªå‹•æŠ•ç¨¿ã‚·ã‚¹ãƒ†ãƒ ï¼ˆæ–°ç€å„ªå…ˆç‰ˆï¼‰ - 15åˆ†é–“éš”å®Ÿè¡Œ
*/15 * * * * cd /home/member1/wordpress-auto-posting && /home/member1/wordpress-auto-posting/venv/bin/python -m src.main --auto --vps-mode >> /home/member1/wordpress-auto-posting/logs/auto_posting.log 2>&1

# æ—¥æ¬¡ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ãƒã‚§ãƒƒã‚¯ - æ¯æ—¥åˆå‰1æ™‚
0 1 * * * cd /home/member1/wordpress-auto-posting && /home/member1/wordpress-auto-posting/venv/bin/python -m src.main --status >> /home/member1/wordpress-auto-posting/logs/daily_status.log 2>&1

# é€±æ¬¡Gitæ›´æ–° - æ¯é€±æ—¥æ›œæ—¥åˆå‰3æ™‚
0 3 * * 0 cd /home/member1/wordpress-auto-posting && git pull origin main >> /home/member1/wordpress-auto-posting/logs/git_update.log 2>&1
EOF

# æ–°ã—ã„cronè¨­å®šã‚’é©ç”¨
crontab /tmp/new_cron

# è¨­å®šç¢ºèª
echo "âœ… æ–°ã—ã„cronè¨­å®šå®Œäº†:"
crontab -l

# ãƒ­ã‚°ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæº–å‚™
mkdir -p /home/member1/wordpress-auto-posting/logs
chmod 755 /home/member1/wordpress-auto-posting/logs

# Pythonãƒãƒ¼ã‚¸ãƒ§ãƒ³ç¢ºèª
python --version

# ä»®æƒ³ç’°å¢ƒç¢ºèª
which python
echo "ä»®æƒ³ç’°å¢ƒ: $(which python)"

## 2. æ–°ç€å„ªå…ˆã‚·ã‚¹ãƒ†ãƒ è¨­å®šç¢ºèª
echo ""
echo "âš™ï¸ æ–°ç€å„ªå…ˆã‚·ã‚¹ãƒ†ãƒ è¨­å®šç¢ºèª..."

# é‡è¦ãªè¨­å®šå€¤ã‚’ç¢ºèª
cat .env | grep -E "MAX_POSTS_PER_RUN|POST_INTERVAL|SEARCH_LIMIT"

# æ–°ç€å„ªå…ˆã‚·ã‚¹ãƒ†ãƒ ç”¨ã«1ä»¶ãƒ¢ãƒ¼ãƒ‰è¨­å®š
echo "æ–°ç€å„ªå…ˆãƒ¢ãƒ¼ãƒ‰è¨­å®šï¼ˆ1ä»¶/15åˆ†ï¼‰:"
echo "MAX_POSTS_PER_RUN=1" >> .env || echo "MAX_POSTS_PER_RUN=1" | tee -a .env
cat .env | grep MAX_POSTS_PER_RUN

# æ¤œç´¢ã‚ªãƒ•ã‚»ãƒƒãƒˆç®¡ç†ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªç¢ºèª
mkdir -p data/
ls -la data/

## 3. æ–°ç€å„ªå…ˆã‚·ã‚¹ãƒ†ãƒ å‹•ä½œãƒ†ã‚¹ãƒˆ
echo ""
echo "ğŸš€ æ–°ç€å„ªå…ˆã‚·ã‚¹ãƒ†ãƒ ãƒ†ã‚¹ãƒˆ..."

# å‹•ä½œãƒ†ã‚¹ãƒˆï¼ˆ1ä»¶å‡¦ç†ï¼‰
echo "æ–°ç€å„ªå…ˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œ:"
timeout 300 python -m src.main --auto --vps-mode

# ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ç¢ºèª
echo "ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ç¢ºèª:"
python -m src.main --status

## 4. æ¤œç´¢ã‚ªãƒ•ã‚»ãƒƒãƒˆç®¡ç†ç¢ºèª
echo ""
echo "ğŸ“ æ¤œç´¢ã‚ªãƒ•ã‚»ãƒƒãƒˆç®¡ç†ç¢ºèª..."

# æ¤œç´¢ã‚ªãƒ•ã‚»ãƒƒãƒˆçŠ¶æ³ã‚’ç¢ºèª
python -c "
from src.core.search_offset_manager import SearchOffsetManager
offset_manager = SearchOffsetManager()
status = offset_manager.get_status()
print(f'æ¤œç´¢ã‚ªãƒ•ã‚»ãƒƒãƒˆçŠ¶æ³: {status}')
"

# æŠ•ç¨¿å±¥æ­´ç¢ºèª
python -c "
from src.core.post_manager import PostManager
pm = PostManager()
count = pm.get_posted_count()
print(f'ç·æŠ•ç¨¿æ•°: {count}ä»¶')
"

## 5. æ–°ç€å„ªå…ˆã‚·ã‚¹ãƒ†ãƒ å‹•ä½œç¢ºèªãƒ†ã‚¹ãƒˆ
echo ""
echo "ğŸ§ª æ–°ç€å„ªå…ˆã‚·ã‚¹ãƒ†ãƒ å‹•ä½œç¢ºèªãƒ†ã‚¹ãƒˆ..."

# æ‰‹å‹•ã§1å›ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
echo "æ–°ç€å„ªå…ˆã‚·ã‚¹ãƒ†ãƒ ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­..."
cd /home/member1/wordpress-auto-posting
timeout 300 python -m src.main --auto --vps-mode

# ãƒ†ã‚¹ãƒˆçµæœç¢ºèª
echo "ãƒ†ã‚¹ãƒˆå®Ÿè¡Œçµæœ:"
tail -20 /home/member1/wordpress-auto-posting/logs/auto_posting.log

# cronè¨­å®šç¢ºèª
echo ""
echo "â° cronè¨­å®šç¢ºèª:"
crontab -l

## 6. å³åº§ã«å‹•ä½œç¢ºèªï¼ˆæ¬¡ã®15åˆ†åˆ»ã¿æ™‚åˆ»ã¾ã§å¾…æ©Ÿï¼‰
echo ""
echo "â° æ¬¡å›cronå®Ÿè¡Œæ™‚åˆ»è¨ˆç®—..."

# ç¾åœ¨æ™‚åˆ»ç¢ºèª
current_time=$(date '+%Y-%m-%d %H:%M')
echo "ç¾åœ¨æ™‚åˆ»: $current_time"

# æ¬¡ã®15åˆ†åˆ»ã¿æ™‚åˆ»ã‚’è¨ˆç®—
current_minute=$(date '+%M')
next_quarter=$((((current_minute / 15) + 1) * 15))

if [ $next_quarter -ge 60 ]; then
    next_hour=$(($(date '+%H') + 1))
    next_minute=0
    if [ $next_hour -ge 24 ]; then
        next_hour=0
        next_date=$(date -d 'tomorrow' '+%Y-%m-%d')
    else
        next_date=$(date '+%Y-%m-%d')
    fi
else
    next_hour=$(date '+%H')
    next_minute=$next_quarter
    next_date=$(date '+%Y-%m-%d')
fi

printf "â° æ¬¡å›è‡ªå‹•å®Ÿè¡Œæ™‚åˆ»: %s %02d:%02d\n" "$next_date" "$next_hour" "$next_minute"

# æ—¢å­˜ãƒ­ã‚°ã®ç¢ºèª
echo ""
echo "ğŸ“ ãƒ­ã‚°ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªç¢ºèª..."
ls -la logs/ | head -10

## 7. WordPress APIæ¥ç¶šãƒ†ã‚¹ãƒˆ
echo ""
echo "ğŸ”— WordPress APIæ¥ç¶šãƒ†ã‚¹ãƒˆ..."

python -c "
from src.config.simple_config_manager import SimpleConfigManager
from src.api.wordpress_api import WordPressAPI

config = SimpleConfigManager()
wp_api = WordPressAPI(
    url=config.wordpress.url,
    username=config.wordpress.username, 
    password=config.wordpress.password
)

try:
    with wp_api:
        result = wp_api.test_connection()
        print(f'WordPressæ¥ç¶š: {\"âœ… OK\" if result else \"âŒ NG\"}')
except Exception as e:
    print(f'WordPressæ¥ç¶šã‚¨ãƒ©ãƒ¼: {e}')
"

## 8. DMM APIæ¥ç¶šãƒ†ã‚¹ãƒˆ
echo ""
echo "ğŸ”— DMM APIæ¥ç¶šãƒ†ã‚¹ãƒˆ..."

python -c "
from src.config.simple_config_manager import SimpleConfigManager
from src.api.dmm_api import DMMAPIClient

config = SimpleConfigManager()
dmm_client = DMMAPIClient(
    api_id=config.dmm_api.api_id,
    affiliate_id=config.dmm_api.affiliate_id,
    request_delay=config.system.request_delay
)

try:
    with dmm_client:
        test_items = dmm_client.get_items(limit=1)
        print(f'DMM APIæ¥ç¶š: {\"âœ… OK\" if len(test_items) > 0 else \"âŒ NG\"}')
        print(f'ãƒ†ã‚¹ãƒˆå–å¾—ä»¶æ•°: {len(test_items)}ä»¶')
except Exception as e:
    print(f'DMM APIæ¥ç¶šã‚¨ãƒ©ãƒ¼: {e}')
"

## 9. ã‚·ã‚¹ãƒ†ãƒ ãƒªã‚½ãƒ¼ã‚¹ç¢ºèª
echo ""
echo "ğŸ’¾ ã‚·ã‚¹ãƒ†ãƒ ãƒªã‚½ãƒ¼ã‚¹ç¢ºèª..."

# ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡
free -h

# ãƒ‡ã‚£ã‚¹ã‚¯ä½¿ç”¨é‡
df -h | grep -E "(Filesystem|/dev/)"

# cronã‚µãƒ¼ãƒ“ã‚¹çŠ¶æ…‹ç¢ºèª
echo "cronã‚µãƒ¼ãƒ“ã‚¹çŠ¶æ…‹:"
sudo systemctl status cron | head -5

## 10. ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–ã‚³ãƒãƒ³ãƒ‰
echo ""
echo "ğŸ‘€ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–ã‚³ãƒãƒ³ãƒ‰:"
echo ""
echo "# è‡ªå‹•æŠ•ç¨¿ãƒ­ã‚°ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–"
echo "tail -f /home/member1/wordpress-auto-posting/logs/auto_posting.log"
echo ""
echo "# ä»Šæ—¥ã®æŠ•ç¨¿çŠ¶æ³ç¢ºèª"
echo "grep 'æŠ•ç¨¿å®Œäº†' /home/member1/wordpress-auto-posting/logs/auto_posting.log | tail -10"
echo ""
echo "# æ¤œç´¢ã‚ªãƒ•ã‚»ãƒƒãƒˆå±¥æ­´ç¢ºèª"
echo "grep 'æ¤œç´¢ä½ç½®' /home/member1/wordpress-auto-posting/logs/auto_posting.log | tail -5"
echo ""
echo "# ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ç¢ºèª"
echo "grep 'ERROR' /home/member1/wordpress-auto-posting/logs/auto_posting.log | tail -5"

## 11. æ–°ç€å„ªå…ˆã‚·ã‚¹ãƒ†ãƒ ã®ç‰¹å¾´ç¢ºèª
echo ""
echo "ğŸ¯ æ–°ç€å„ªå…ˆã‚·ã‚¹ãƒ†ãƒ å‹•ä½œç¢ºèª..."

python -c "
from pathlib import Path
import json

# æ¤œç´¢ã‚ªãƒ•ã‚»ãƒƒãƒˆãƒ•ã‚¡ã‚¤ãƒ«ç¢ºèª
offset_file = Path('data/search_offset.json')
if offset_file.exists():
    with open(offset_file, 'r', encoding='utf-8') as f:
        offset_data = json.load(f)
    print(f'ğŸ” ç¾åœ¨ã®æ¤œç´¢ä½ç½®: {offset_data.get(\"next_offset\", \"ä¸æ˜\")}ä»¶ç›®ã‹ã‚‰')
    print(f'ğŸ“… æœ€çµ‚æ›´æ–°: {offset_data.get(\"last_updated\", \"ä¸æ˜\")}')
else:
    print('ğŸ” æ¤œç´¢ã‚ªãƒ•ã‚»ãƒƒãƒˆãƒ•ã‚¡ã‚¤ãƒ«æœªä½œæˆï¼ˆåˆå›å®Ÿè¡Œæ™‚ã«ä½œæˆã•ã‚Œã¾ã™ï¼‰')

# æŠ•ç¨¿å±¥æ­´ãƒ•ã‚¡ã‚¤ãƒ«ç¢ºèª
posted_file = Path('data/posted_works.json')
if posted_file.exists():
    with open(posted_file, 'r', encoding='utf-8') as f:
        posted_data = json.load(f)
    posted_count = len(posted_data.get('posted_work_ids', []))
    print(f'ğŸ“ æŠ•ç¨¿æ¸ˆã¿ä½œå“æ•°: {posted_count}ä»¶')
else:
    print('ğŸ“ æŠ•ç¨¿å±¥æ­´ãƒ•ã‚¡ã‚¤ãƒ«æœªä½œæˆï¼ˆåˆå›æŠ•ç¨¿æ™‚ã«ä½œæˆã•ã‚Œã¾ã™ï¼‰')
"

## 12. ç·Šæ€¥æ™‚ã®ã‚³ãƒãƒ³ãƒ‰
echo ""
echo "ğŸš¨ ç·Šæ€¥æ™‚ã‚³ãƒãƒ³ãƒ‰:"
echo ""
echo "# ãƒ—ãƒ­ã‚»ã‚¹å¼·åˆ¶çµ‚äº†"
echo "pkill -f 'python -m src.main'"
echo ""
echo "# æ¤œç´¢ã‚ªãƒ•ã‚»ãƒƒãƒˆãƒªã‚»ãƒƒãƒˆï¼ˆ1ä»¶ç›®ã‹ã‚‰å†é–‹ï¼‰"
echo "rm -f data/search_offset.json"
echo ""
echo "# æŠ•ç¨¿å±¥æ­´ãƒªã‚»ãƒƒãƒˆï¼ˆå…¨ä½œå“ã‚’æœªæŠ•ç¨¿çŠ¶æ…‹ã«ï¼‰"
echo "rm -f data/posted_works.json"
echo ""
echo "# ãƒ­ã‚°ã‚’å…¨ã¦å‰Šé™¤"
echo "rm -f logs/*"
echo ""
echo "# cronã‚¸ãƒ§ãƒ–åœæ­¢"
echo "crontab -r"

## 13. æ‰‹å‹•å®Ÿè¡Œã‚³ãƒãƒ³ãƒ‰
echo ""
echo "ğŸ”§ æ‰‹å‹•å®Ÿè¡Œã‚³ãƒãƒ³ãƒ‰:"
echo ""
echo "# 1å›åˆ†ã®è‡ªå‹•æŠ•ç¨¿å®Ÿè¡Œ"
echo "cd /home/member1/wordpress-auto-posting && python -m src.main --auto --vps-mode"
echo ""
echo "# ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ç¢ºèª"
echo "cd /home/member1/wordpress-auto-posting && python -m src.main --status"
echo ""
echo "# æ¥ç¶šãƒ†ã‚¹ãƒˆ"
echo "cd /home/member1/wordpress-auto-posting && python -m src.main --test"

## 14. å®Ÿè¡Œçµæœã‚µãƒãƒªãƒ¼
echo ""
echo "ğŸ“‹ æ–°ç€å„ªå…ˆæŠ•ç¨¿ã‚·ã‚¹ãƒ†ãƒ æƒ…å ±ã‚µãƒãƒªãƒ¼:"
echo "ãƒãƒ¼ã‚¸ãƒ§ãƒ³: v4.0.0ï¼ˆæ–°ç€å„ªå…ˆãƒ»æŠ•ç¨¿ãƒ©ã‚°æœ€å°åŒ–ç‰ˆï¼‰"
echo ""
echo "ğŸ¯ ä¸»è¦æ©Ÿèƒ½:"
echo "- æ–°ç€å„ªå…ˆå‡¦ç†: 96ä»¶ç™ºè¦‹æ™‚ã‚‚1ä»¶ãšã¤15åˆ†é–“éš”ã§æŠ•ç¨¿"
echo "- æŠ•ç¨¿ãƒ©ã‚°æœ€å°åŒ–: æ–°ç€ä½œå“ã®æœ€å¤§æŠ•ç¨¿ãƒ©ã‚°15åˆ†"
echo "- æ¤œç´¢ã‚ªãƒ•ã‚»ãƒƒãƒˆç®¡ç†: åŒã˜ç¯„å›²ã‚’ç¶™ç¶šæ¤œç´¢"
echo "- æŠ•ç¨¿å±¥æ­´ç®¡ç†: æ—¢æŠ•ç¨¿ä½œå“ã®è‡ªå‹•é™¤å¤–"
echo "- WordPressã‚¢ã‚¤ã‚­ãƒ£ãƒƒãƒç”»åƒè‡ªå‹•è¨­å®š"
echo ""
echo "ğŸ”„ å‹•ä½œãƒ•ãƒ­ãƒ¼ä¾‹:"
echo "00:00 â†’ 1-100ä»¶æ¤œç´¢ â†’ 96ä»¶ç™ºè¦‹ â†’ 1ä»¶æŠ•ç¨¿ â†’ æ¤œç´¢ä½ç½®ç¶­æŒ"
echo "00:15 â†’ 1-100ä»¶æ¤œç´¢ â†’ 95ä»¶ç™ºè¦‹ â†’ 1ä»¶æŠ•ç¨¿ â†’ æ¤œç´¢ä½ç½®ç¶­æŒ"
echo "00:30 â†’ 1-100ä»¶æ¤œç´¢ â†’ 94ä»¶ç™ºè¦‹ â†’ 1ä»¶æŠ•ç¨¿ â†’ æ¤œç´¢ä½ç½®ç¶­æŒ"
echo "... (96å›å®Ÿè¡Œã§å…¨ä»¶å‡¦ç†å®Œäº†)"
echo "24:00 â†’ 1-100ä»¶æ¤œç´¢ â†’ 0ä»¶ç™ºè¦‹ â†’ 101-200ä»¶æ¤œç´¢ã«ç§»è¡Œ"
echo ""
echo "âœ… è¨­å®šå®Œäº†ï¼æ–°ç€å„ªå…ˆæŠ•ç¨¿ã‚·ã‚¹ãƒ†ãƒ ãŒ15åˆ†é–“éš”ã§å‹•ä½œã—ã¾ã™ã€‚"