# VPS æœ¬ç•ªè¨˜äº‹ç”Ÿæˆãƒ»æŠ•ç¨¿ãƒ†ã‚¹ãƒˆã‚³ãƒžãƒ³ãƒ‰ï¼ˆPostScheduleManagerä¿®æ­£ç‰ˆï¼‰

# æ–¹æ³•0: VPSæ›´æ–°ï¼ˆå¿…è¦ã«å¿œã˜ã¦å®Ÿè¡Œï¼‰
./scripts/vps_update.sh

# æ–¹æ³•1: ç’°å¢ƒå¤‰æ•°è¨­å®š
echo "ðŸ”§ å¿…è¦ãªç’°å¢ƒå¤‰æ•°ã‚’æ‰‹å‹•è¨­å®š..."
export WORDPRESS_PASSWORD='zhC2 MaOT aDBC G2lz oWyT aEuU'
export DMM_API_ID='gD92abXPQ9hZn9nzDR0v'
export DMM_AFFILIATE_ID='fanz0077-990'

# .envãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰GEMINI_API_KEYã‚’å–å¾—
echo "ðŸ“¥ GEMINI_API_KEY ã‚’ .env ã‹ã‚‰å–å¾—..."
GEMINI_KEY=$(grep GEMINI_API_KEY .env | cut -d'=' -f2)
export GEMINI_API_KEY="$GEMINI_KEY"

echo "è¨­å®šå®Œäº†å¾Œã®ç’°å¢ƒå¤‰æ•°ç¢ºèª:"
echo "WORDPRESS_PASSWORD: $(if [ -n "$WORDPRESS_PASSWORD" ]; then echo "è¨­å®šæ¸ˆã¿"; else echo "æœªè¨­å®š"; fi)"
echo "GEMINI_API_KEY: $(if [ -n "$GEMINI_API_KEY" ]; then echo "è¨­å®šæ¸ˆã¿"; else echo "æœªè¨­å®š"; fi)"
echo "DMM_API_ID: $(if [ -n "$DMM_API_ID" ]; then echo "è¨­å®šæ¸ˆã¿"; else echo "æœªè¨­å®š"; fi)"
echo "DMM_AFFILIATE_ID: $(if [ -n "$DMM_AFFILIATE_ID" ]; then echo "è¨­å®šæ¸ˆã¿"; else echo "æœªè¨­å®š"; fi)"
echo ""

# æ–¹æ³•2: å®Ÿéš›ã®ä½œå“ãƒ‡ãƒ¼ã‚¿ã§è¨˜äº‹ç”Ÿæˆãƒ†ã‚¹ãƒˆï¼ˆPostScheduleManagerä¿®æ­£ç‰ˆï¼‰
cat > real_post_test.py << 'EOF'
import os
from src.api.dmm_api import DMMAPIClient
from src.api.gemini_api import GeminiAPI
from src.core.post_schedule_manager import PostScheduleManager
from src.config.secure_config_manager import SecureConfigManager
from datetime import datetime, timedelta

print("ðŸŽ¯ æœ¬ç•ªè¨˜äº‹ç”Ÿæˆãƒ†ã‚¹ãƒˆé–‹å§‹...")

try:
    config = SecureConfigManager()
    dmm_client = DMMAPIClient("gD92abXPQ9hZn9nzDR0v", "fanz0077-990")
    
    # GeminiAPIã‚­ãƒ¼ã‚’ç›´æŽ¥ç’°å¢ƒå¤‰æ•°ã‹ã‚‰å–å¾—
    gemini_api_key = os.getenv('GEMINI_API_KEY')
    gemini_api = GeminiAPI(api_key=gemini_api_key)

    # ã‚¸ãƒ£ãƒ³ãƒ«ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æœ‰åŠ¹ã§ä½œå“å–å¾—
    items = dmm_client.get_items(limit=5, offset=1, use_genre_filter=True)
    print("å–å¾—ã‚¢ã‚¤ãƒ†ãƒ æ•°:", len(items))

    if items:
        for item in items:
            work_data = dmm_client.convert_to_work_data(item, skip_review_check=True)
            if work_data:
                title = work_data["title"]
                print(f"âœ… ä½œå“å¤‰æ›æˆåŠŸ: {title}")
                article = gemini_api.rewrite_description(title=work_data["title"], original_description=work_data["description"])
                if article:
                    schedule_manager = PostScheduleManager(config)
                    target_time = datetime.now() + timedelta(minutes=2)
                    schedule_id = schedule_manager.schedule_post(work_data=work_data, article_content=article, scheduled_time=target_time)
                    time_str = target_time.strftime("%H:%M:%S")
                    print(f"ðŸŽ‰ äºˆç´„æŠ•ç¨¿è¨­å®šå®Œäº†: {schedule_id}")
                    print(f"ðŸ“… æŠ•ç¨¿äºˆå®š: {time_str}")
                    print(f"ðŸ“ ä½œå“: {title}")
                    break
                else:
                    print("âŒ è¨˜äº‹ç”Ÿæˆå¤±æ•—")
    else:
        print("âŒ ä½œå“å–å¾—å¤±æ•—")

except Exception as e:
    print(f"âŒ ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ: {e}")
    import traceback
    traceback.print_exc()
EOF

python real_post_test.py
rm real_post_test.py

# æ–¹æ³•3: äºˆç´„æŠ•ç¨¿å®Ÿè¡Œï¼ˆ2åˆ†å¾Œï¼‰
echo "â° 2åˆ†å¾Œã«ä»¥ä¸‹ã‚³ãƒžãƒ³ãƒ‰ã§æŠ•ç¨¿å®Ÿè¡Œï¼š"
echo "python execute_scheduled_posts.py --vps-mode --multiple 1"

# æ–¹æ³•4: ç¾åœ¨ã®äºˆç´„çŠ¶æ³ç¢ºèª
python execute_scheduled_posts.py --vps-mode --status

# æ–¹æ³•5: ãƒ­ã‚°ç¢ºèª
tail -10 logs/auto_post_$(date +%Y%m%d).log