# 前倒し投稿システム仕様書

## 概要

複数のレビュー付き商品が発見された際に、次回以降の投稿を前倒しで予約投稿する機能。

## システム動作フロー

### 1. 通常の投稿処理
```
DMM検索 → 1件のレビュー付き商品発見 → 翌日の予定時刻で投稿予約
```

### 2. 前倒し投稿処理
```
DMM検索 → 複数件(2-3件)のレビュー付き商品発見 → 即座に15分間隔で前倒し投稿予約
```

## 実装詳細

### レビュー条件
- **変更前**: レビュー数 >= 2件
- **変更後**: レビュー数 >= 1件（既に実装済み）

### 前倒し投稿のトリガー条件
- 1回の実行で**複数件（2件以上）**のレビュー付き商品が発見された場合
- 最大3件まで処理対象

### 投稿スケジュール

#### 通常投稿（1件発見時）
```
実行時刻: 15:00
投稿予約: 翌日 00:00 (15分間隔の通常スケジュール)
```

#### 前倒し投稿（複数件発見時）
```
実行時刻: 15:07
投稿予約: 15:15, 15:30, 15:45 (次の15分刻み枠から15分間隔)
```

**重要**: 1日96件制限を維持し、既存予約と重複しない15分刻み時刻に自動配置

## 技術実装

### 1. PostScheduleManager の拡張

#### 新メソッド: `create_advance_schedule`
```python
def create_advance_schedule(self, articles: List[Dict]) -> Dict:
    """
    15分刻みスケジュール内での前倒し投稿予約
    
    Args:
        articles: 記事データのリスト（最大3件）
    
    Returns:
        作成されたスケジュール情報
    """
```

**特徴**:
- 次の15分刻み時刻から開始（例: 15:07実行→15:15開始）
- 既存予約と重複回避の自動スケジューリング
- 1日96件制限の自動管理
- 高優先度（`priority="high"`）で設定
- スケジュールID形式: `advance_YYYYMMDD_HHMM_xxxxxxxx`
- 当日枠満杯時は翌日自動振り分け

### 2. AutoPostingSystem の拡張

#### 新メソッド: `_process_works_advance_schedule`
```python
def _process_works_advance_schedule(self, works: List[Dict]) -> int:
    """15分刻みスケジュール内前倒し投稿処理"""
```

**処理フロー**:
1. 複数作品の記事生成を並行実行
2. 15分刻みスケジュール内で前倒し投稿予約を作成
3. 当日枠満杯時は翌日への自動振り分け
4. 投稿済みフラグを設定
5. ログ出力でスケジュール詳細を通知

#### 修正メソッド: `_process_works`
```python
# 複数作品が見つかった場合は15分刻み前倒し投稿を実行
if len(works_to_process) > 1:
    return self._process_works_advance_schedule(works_to_process)
else:
    # 単一作品の場合は従来の処理
    return self._process_works_regular_schedule(works_to_process, total_posted_count)
```

### 3. 予約投稿実行システム

#### 新スクリプト: `execute_scheduled_posts.py`
- 15分間隔でcron実行される専用スクリプト
- 予約投稿の実行とステータス管理
- 失敗投稿の回復機能

**主要機能**:
```bash
# 次の予約投稿を1件実行
python execute_scheduled_posts.py --vps-mode

# 予約投稿状況を表示
python execute_scheduled_posts.py --status --vps-mode

# 最大3件まで連続実行（遅延回復用）
python execute_scheduled_posts.py --multiple 3 --vps-mode
```

## cron設定

### VPS用cron設定
```bash
# 15分間隔で予約投稿実行
*/15 * * * * cd /opt/blog-automation && source venv/bin/activate && python execute_scheduled_posts.py --vps-mode >> logs/cron.log 2>&1

# 1時間おきに新規記事検索・生成
0 * * * * cd /opt/blog-automation && source venv/bin/activate && python main.py --vps-mode >> logs/cron.log 2>&1
```

## ログ出力例

### 前倒し投稿実行時
```
2025-08-02 15:07:12 - 複数作品発見（3件）- 15分刻み前倒し投稿を実行します
2025-08-02 15:07:45 - 記事生成完了: 作品タイトル1
2025-08-02 15:08:23 - 記事生成完了: 作品タイトル2  
2025-08-02 15:08:58 - 記事生成完了: 作品タイトル3
2025-08-02 15:09:01 - 利用可能な15分刻み枠: 3件 (必要: 3件)
2025-08-02 15:09:01 - 前倒し投稿スケジュール作成: 3件
2025-08-02 15:09:01 - 投稿予定時刻: 2025-08-02 15:15, 2025-08-02 15:30, 2025-08-02 15:45
```

### 当日枠満杯時の翌日振り分け
```
2025-08-02 23:50:12 - 複数作品発見（2件）- 15分刻み前倒し投稿を実行します
2025-08-02 23:50:45 - 利用可能な15分刻み枠: 1件 (必要: 2件)
2025-08-02 23:50:45 - 今日の投稿枠満杯のため翌日振り分けます
2025-08-02 23:50:46 - 翌日投稿スケジュール作成完了: 2件 (開始: 2025-08-03 00:00)
2025-08-02 23:50:46 - 今日の投稿枠満杯のため翌日振り分け: 2件
2025-08-02 23:50:46 - 翌日投稿予定時刻: 2025-08-03 00:00, 2025-08-03 00:15
```

### 予約投稿実行時
```
2025-08-02 15:15:30 - 予約投稿実行開始: 作品タイトル1 (ID: advance_20250802_1515_a1b2c3d4)
2025-08-02 15:15:45 - WordPress投稿成功: 作品タイトル1【作者名】 (ID: 12345)
2025-08-02 15:15:45 - 予約投稿完了: 作品タイトル1 (実行時間: 15.2秒)
```

## 効果・メリット

### 1. 投稿頻度の最適化
- **通常時**: 24時間に1件（翌日予約）
- **複数発見時**: 15分間隔で最大3件の前倒し投稿（15分刻みスケジュール内）

### 2. ユーザー体験の向上
- 良質なコンテンツが見つかった際の迅速な投稿
- 15分間隔による適度な投稿間隔

### 3. システム効率化
- 1回の検索で複数記事を効率的に処理
- 15分刻みスケジュール内での前倒し投稿
- 1日96件制限の自動管理と競合回避

## 設定パラメータ

### config.vps.ini
```ini
[settings]
# 1回の実行で処理する最大作品数（前倒し投稿対応）
max_posts_per_run = 3

# 投稿間隔（分）- 前倒し投稿でも使用
post_interval = 15
```

### 前倒し投稿固有設定
- **スケジュール方式**: 次の15分刻み時刻から開始
- **最大件数**: 3件（負荷とユーザー体験のバランス）
- **優先度**: 高（通常予約より優先実行）
- **競合回避**: 既存予約との自動重複チェック
- **日次制限**: 96件/日の自動管理

## 運用上の注意点

### 1. API制限への配慮
- DMM API: 1回の検索で複数記事を効率的に取得
- WordPress API: 15分間隔での投稿でサーバー負荷を分散

### 2. 重複投稿の防止
- 投稿済みフラグの即座設定
- スケジュールID の一意性保証

### 3. 失敗時の回復
- 自動リトライ機能（最大3回）
- 失敗投稿の再スケジュール機能

## 今後の拡張可能性

### 1. 動的間隔調整
- 投稿時間帯に応じた間隔調整
- ユーザーアクセス状況に基づく最適化

### 2. 予約投稿の優先度制御
- レビュー数に応じた優先度設定
- 人気度による前倒し判定

### 3. バッチ処理の最適化
- より多くの記事の一括処理
- 並行処理による高速化

---

**実装完了日**: 2025-08-02  
**対応バージョン**: v1.2+