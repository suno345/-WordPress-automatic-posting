# WordPress自動投稿システム仕様書

## 1. 概要

FANZAの同人作品情報を元に、AI(Gemini)を活用してユニークな紹介記事を生成し、指定したスケジュールでWordPressに自動で予約投稿するPython製のシステム。ブログコンテンツの継続的な更新を自動化し、アフィリエイト収益の向上を目指す。

## 2. システムアーキテクチャ

- **実行環境:** VPS (仮想専用サーバー)
- **主要言語:** Python
- **フレームワーク/ライブラリ:**
    - `requests`: HTTP通信
    - `beautifulsoup4`: HTML解析
    - `google-generativeai`: Gemini API連携
    - `python-wordpress-xmlrpc`: WordPress連携
- **連携サービス:**
    - **WordPress:** 投稿先 (REST API/XML-RPC)
    - **FANZA:** 情報取得元
    - **Gemini API:** 記事生成AI

## 3. ディレクトリ構造

```
/
├── main.py                 # メインエントリーポイント
├── execute_scheduled_posts.py # 予約投稿実行スクリプト
├── requirements.txt        # 依存ライブラリ
├── config/                 # 設定ファイル
│   ├── config.ini          # APIキー、DB設定など
│   └── review_patterns.yaml # レビューパターン
├── src/                    # ソースコード
│   ├── api/                # 外部API連携
│   ├── core/               # 中核ロジック (記事生成、投稿管理)
│   ├── database/           # データベース関連
│   ├── services/           # 各種サービス (エラー処理、セキュリティ)
│   ├── utils/              # 共通ユーティリティ
│   └── config/             # 設定管理
├── data/                   # データファイル
│   ├── posted_works.json   # 投稿済み作品IDリスト
│   └── swell_blocks.json   # SWELLブロック定義
├── logs/                   # ログファイル
├── scripts/                # シェルスクリプト (cron設定、VPSセットアップ)
├── templates/              # 記事テンプレート
└── tests/                  # テストコード
```

## 4. 主要機能

### 4.1. 作品情報取得機能

- **情報取得元:** FANZAの同人作品リストページ
- **取得プロセス:**
    1. 指定されたURLから作品リストをクロール。
    2. 各作品の詳細ページURLを取得。
    3. `data/posted_works.json`を参照し、投稿済みの作品はスキップ。
    4. 未投稿の作品ページから以下の情報を抽出。
        - 作品タイトル
        - サークル名、作者名
        - カテゴリ
        - パッケージ画像URL
        - 公式の作品紹介文
        - 作品ページ数
        - ジャンル
        - サンプル画像URL
        - レビュー
        - アフィリエイトリンク生成用の情報

### 4.2. 記事生成機能 (AI連携)

- **使用AI:** Gemini API
- **プロセス:**
    1. 取得した作品情報を元に、プロンプトを生成。
    2. Gemini APIにリクエストを送信し、約180字のユニークな紹介文を生成。
    3. `templates/`内のテンプレートと生成された文章を組み合わせ、以下の構成で記事HTMLを生成。
        - **タイトル:** `[作品名]`
        - **タグ:** `作者名`, `サークル名`
        - **カテゴリ:** FANZAのカテゴリ
        - **本文:**
            - 導入文
            - パッケージ画像
            - AI生成の紹介文
            - 作品情報（ページ数、ジャンル）
            - サンプル画像
            - アフィリエイトリンクボタン (SWELLブロック)
            - レビュー
            - H2見出し (複数パターンからランダム選択)

### 4.3. 投稿管理機能

- **重複投稿防止:**
    - 投稿が成功した作品のIDを`data/posted_works.json`に記録。
    - 実行時にこのファイルを読み込み、処理対象から除外する。
- **予約投稿:**
    - WordPressのAPIを利用し、生成した記事を**翌日**の日付で予約投稿する。
    - 実行タイミングはcronによって制御される。

### 4.4. スケジューリング・自動実行

- **実行管理:** `setup_cron.sh`により、VPSのcronに定時実行ジョブを登録。
- **実行間隔:** 15分に1回、`execute_scheduled_posts.py`を実行。

## 5. 処理フロー

1.  **[cron]** 定刻になると`execute_scheduled_posts.py`が実行される。
2.  **[設定読込]** `config/config.ini`から各種設定を読み込む。
3.  **[重複確認]** `data/posted_works.json`を読み込み、投稿済みIDリストを取得。
4.  **[情報取得]** FANZAサイトをクロールし、未投稿の作品情報を取得。
5.  **[記事生成]** 取得情報を元にGemini APIで紹介文を生成し、記事データを作成。
6.  **[予約投稿]** WordPress APIを呼び出し、翌日付で予約投稿。
7.  **[記録]** 投稿に成功した作品IDを`data/posted_works.json`に追記。
8.  **[ログ出力]** 処理結果を`logs/`ディレクトリに記録して終了。

## 6. セキュリティ

- **機密情報管理:** APIキーやパスワードは`config.ini`で管理し、`.gitignore`でリポジトリから除外。
- **暗号化:** `.encryption_key`を使用し、重要な設定情報を暗号化する仕組みを持つ。
- **アクセス制御:** VPSへのアクセスはSSHキー認証を推奨。

## 7. 運用・保守

- **ログ:** `logs/`ディレクトリに日付ごとのログが出力される。エラー発生時はログを確認。
- **設定変更:** APIキーや投稿設定の変更は`config/config.ini`を編集する。
- **テスト:** `tests/`ディレクトリに単体・結合テストが用意されており、`pytest`で実行可能。
